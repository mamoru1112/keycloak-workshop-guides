[#firstapp-project]
=== Java Script Client Adapterについて
RH-SSOには、HTML5/JavaScriptアプリケーションのセキュリティ確保に使用できるクライアントサイドJavaScriptライブラリが付属しています。
今回のアプリでは、このライブラリを使っており、Web画面上でアクセストークンなどをがアプリケーション側でどう見えるかが簡単に確認できるものになっています。

開発環境の画面に移動して、 ターミナルで `js-console`　のディレクトリに移動します。
[source, js,role="copypaste"]
----
cd js-console
----

[#firstapp-authentication]
=== JavaScirptによる認証
SSOを実現するには、アプリケーション側に、RH-SSOのURLを設定する必要があります。

SSOサーバーのURLをコピーしておきます：
OpenShiftのコマンドでSSOサーバーのホスト名は取得できます(https://は含まれてません)：
```
> oc get route sso
NAME   HOST/PORT                                              PATH   SERVICES   
sso    sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}       sso        <all>
```

`src/keycloak.json` ファイルを編集します。

以下の "auth-server-url" をSSOサーバのURLに変更します。
[source, js,role="copypaste"]
----
{
  "realm" : "demojs",
  "auth-server-url" : "https://sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}/auth",
  "resource" : "js-console"
}

----

次に、 `src/index.html` を開き、<header> <src>のSERVER_URLの部分を置き換えます。

サーバーのURLは、以下のようになります。

[source, js,role="copypaste"]
----

    <script src="https://sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}/auth/js/keycloak.js"></script>

----


基本的な設定ができたので、アプリケーションをデプロイしていきます。
OpenShiftのS2i（Source2Image）という機能を使って、ソースコードからコンテナを作成します。
また、OpenShiftでデフォルトで提供されているhttpd(Apache Web Server)に、今回のJavaScriptを格納します。

`js-console/src` に移動して以下のコマンドを実行します。

[source, bash,role="copypaste"]
----

oc new-build --name js-console --binary --strategy source --image-stream httpd
----

ビルドを開始します。以下のコマンドでは、ビルドがローカルのソースディレクトリから行われることを指定しています。

[source, bash,role="copypaste"]
----
oc start-build js-console --from-dir . --follow
----

ビルドが成功したら、そのビルドで新しいアプリを作成します。これがjs-consoleアプリになります。

[source, bash,role="copypaste"]
----
oc new-app --image-stream=js-console:latest
----

そして、最後にjs-consoleアプリのサービスのルートを公開し、ブラウザから接続できるようにします。

[source, bash,role="copypaste"]
----
oc expose svc/js-console
----

[#firstapp-deployment]

image::OpenShift-first-deployment.png[First deployment, 1024]

OpenShiftコンソール上で、`js-console` が表示されるはずです。
アイコンの右上にアクセスすると、エラーになっていまいます。
もっと設定を行う必要があります。お気づきかもしれませんが、js-consoleアプリのRH-SSO側の設定まだしていないためです。次にRH-SSO側の設定していきます。

RH-SSO管理画面の左のメニューバー `Client` をクリックします。(認証認可の世界では、SSOで連携するアプリケーションをClientと呼びます)
次に、`Create` ボタンをクリックします。

設定には、js-consoleのURLが必要になります。開発環境の画面のターミナルから、次のコマンドで取得します。

[source, bash,role="copypaste"]
----
oc get route js-console
----

フォームに必要事項を入力し（例：以下の画面）、 `save` をクリックします。
js-consoleアプリのURLには、 "http://" を先頭につけてください (例: "http://js-console-evals01-sso-kubernetes-workshop.apps.cph-5a34.open.redhat.com" )

image::sso_adminclientconfig.png[Realm Client settings]

JS Consoleアプリを再読み込みしてください。ログインページにリダイレクトされるはずです。

Register a new user with an email address.

image::sso_create-user.png[Create user]


After registration you should be able to login and should see the following Console with your registered users Name

image::sso_demojsconsole.png[JS Console]


Congratulations!

- Configured your first SSO JS App.

- deployed the JS App via image stream

- And how the JS Adapter works.

And it only get interesting from here on. This app is our basis for these excercises. Lets head off to the next section and what more can we do with OIDC.














