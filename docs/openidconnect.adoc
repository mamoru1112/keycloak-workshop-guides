[#openid-claims]
== トークンへのクレーム(項目)の追加
前のセクションでは、js-consoleアプリを作成し、アプリをOIDC(認可コード)の設定をしました。
本セクションでは、トークンにクレームを追加します。
トークンにクレームを追加することで、アプリ側で細かい認可の設定が可能になります。(実際は、アプリ側でクレームの内容を処理する必要があります)

[#openid-client-scopes]
=== クライアントスコープとは？
組織内などで保護および登録する必要のあるアプリケーションが多数ある場合、これらのアプリケーションごとにRH-SSOで設定するのは面倒になることがあります。
RH-SSO では、クライアントスコープと呼ばれ機能で共有設定を定義することができます。

今回は、ユーザ情報にアバターを追加して、アプリにアバターを表示させます。

<1> RH-SSOの管理画面に、Adminでログインします。

<2> 左メニューのUsersを開きます。

<3> `View all users`　をクリックします。

<4> `Attributes` タブをクリックし、 Keyに `avatar_url` を入力 

<5> `value`　に https://www.keycloak.org/resources/images/keycloak_logo_200px.svg を入力します

<6> `Save` をクリックします。

ユーザの属性に、アバターを設定したので、次はアプリケーション側を設定して、トークンに追加されるようにします。

- Click on Client Scopes then Create. 

Fill in the following values:

    Name: avatar
    Consent Screen Text: Avatar

- Click on Save. 
- Click on Mappers then Create.

Fill in the following values:

    Name: avatar
    Mapper Type: User Attribute
    User Attribute avatar_url
    Token Claim Name: avatar_url
    Claim JSON Type: String

- Click Save.

Now we've created a client scope, but we also need to asign it to the client, so that our client 'js-console' can reflect the change as well.

- Go to Clients and select js-console. Select Client Scopes.

- We're going to add it as a Default Client Scope. So select the avatar here and click 'Add selected'. As it's a default scope it is added to the token by default, if it's set as an optional client scope the client has to explicitly request it with the scope parameter.

- Now go back to the JS Console and click Refresh. You should see a keycloak logo as your avatar on the main JS Console dashboard.

- Click on `ID Token JSON` and `Access Token JSON` links and you can see the custom attribute added into the token as well. 

- Refresh your JS Console

[source, json]
----
"avatar_url": "https://www.keycloak.org/resources/images/keycloak_logo_200px.svg",

----

And also on the front page of the JS Console

image::sso_jsconsoleuseravatar.png[User Consent]

[#openid-consent]
== Requiring Consent
So far we've assumed the JS Console is an internal trusted application, but what if it's a third party external application? In that case we probably want the user to grant access to what the application wants to have access to.

- Open the Keycloak `Admin Console`

- Go to `Clients`, select JS Console and turn on Consent Required.

-  Press Save 

- Go back to the JS Console and click Login again.

Now you have successfully configured a consent. And you can see that it also shows the different attributes that you are consenting too. 
You can grant consent and should then be able to see the grants. Lets move on to learn more about that.

image::sso_adminuserconsent.png[User Consent]


Lets say if the user didnt want to consent any longer. They could goto to the accounts page and remove the consent. 

Hit the account portal url e.g. <SERVER_URL>/auth/realms/demojs/account
e.g. https://sso-evals01-sso-kubernetes-workshop.apps.cph-5a34.open.redhat.com/auth/realms/demojs/account

You can press the `Revoke Grant` and premissions will be removed.

image::sso_useraccountrevoke.png[Revoking grants]


All the granted permissions and list of applictions will be listed. As you can see Account does not have a Consent, and hence does not offer the revoke options. This is very useful when multiple solutions an applications are connected to single sign on like Red Hat SSO.

You should turn this off again before continuing.

Congratulations you have completed this exercise. 

- We have understood Open Id Connect

- Comparision of SAML and OIDC

- Configuring Client scopes, mappers and Grants. 

Lets move on the next section and get into some more details.

