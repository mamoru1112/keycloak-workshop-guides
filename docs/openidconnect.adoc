[#openid-claims]
== トークンへのクレーム(属性)の追加
前のセクションでは、js-consoleアプリを作成し、アプリをOIDC(認可コード)の設定をしました。
本セクションでは、トークンにクレームを追加します。
トークンにクレームを追加することで、アプリ側で細かい認可の設定が可能になります。(実際は、アプリ側でクレームの内容を処理する必要があります)

[#openid-client-scopes]
=== クライアントスコープとは？
組織内などで保護および登録する必要のあるアプリケーションが多数ある場合、これらのアプリケーションごとにRH-SSOで設定するのは面倒になることがあります。
RH-SSO では、クライアントスコープと呼ばれ機能で共有設定を定義することができます。

今回は、ユーザ情報にアバターを追加して、アプリにアバターを表示させます。

<1> RH-SSOの管理画面に、Adminでログインします。

<2> 左メニューの `Users` を開きます。

<3> `View all users`　をクリックします。

<4> `Attributes` タブをクリックし、 Keyに `avatar_url` を入力 

<5> `value`　に https://www.keycloak.org/resources/images/keycloak_logo_200px.svg を入力します

<6> `Save` をクリックします。

ユーザの属性に、アバターを設定したので、次はアプリケーション側を設定して、トークンに追加されるようにします。

- 左メニューの `Client Scopes` を開いて、 `Create` をクリックします。

以下の値を入力します:

    Name: avatar
    Consent Screen Text: Avatar

- `Save` をクリックします。
- 　同じ画面上にある `Mappers` をクリックして、 `Create` をクリックします。

以下の値を入力します:

    Name: avatar
    Mapper Type: User Attribute
    User Attribute avatar_url
    Token Claim Name: avatar_url
    Claim JSON Type: String

- `Save` をクリックします。

クライアントスコープを作成しましたが、これは共通定義なので、アプリケーションの `js-console` にも変更を反映させる必要があります。

- 左メニューの `Clients` を開いて、 `js-console` をクリックし、 `Client Scopes` タブをクリックします。

- Default Client Scopeとして追加することにします。ここで `avatar` をクリックし、 `Add selected` をクリックします。デフォルトのスコープなので、デフォルトでトークンに追加されます。

- 次に、JS Consoleのアプリに戻り、 `refresh` をクリックします。JS Consoleのメインダッシュボードにアバターとしてkeycloakのロゴが表示されます。

- `Access Token JSON`　をクリックすると、トークンに追加された内容も表示されます。 以下は、 `Access Token JSON`　の追加された行です。

[source, json]
----
"avatar_url": "https://www.keycloak.org/resources/images/keycloak_logo_200px.svg",

----

And also on the front page of the JS Console

image::sso_jsconsoleuseravatar.png[User Consent]

[#openid-consent]
== Requiring Consent
So far we've assumed the JS Console is an internal trusted application, but what if it's a third party external application? In that case we probably want the user to grant access to what the application wants to have access to.

- Open the Keycloak `Admin Console`

- Go to `Clients`, select JS Console and turn on Consent Required.

-  Press Save 

- Go back to the JS Console and click Login again.

Now you have successfully configured a consent. And you can see that it also shows the different attributes that you are consenting too. 
You can grant consent and should then be able to see the grants. Lets move on to learn more about that.

image::sso_adminuserconsent.png[User Consent]


Lets say if the user didnt want to consent any longer. They could goto to the accounts page and remove the consent. 

Hit the account portal url e.g. <SERVER_URL>/auth/realms/demojs/account
e.g. https://sso-evals01-sso-kubernetes-workshop.apps.cph-5a34.open.redhat.com/auth/realms/demojs/account

You can press the `Revoke Grant` and premissions will be removed.

image::sso_useraccountrevoke.png[Revoking grants]


All the granted permissions and list of applictions will be listed. As you can see Account does not have a Consent, and hence does not offer the revoke options. This is very useful when multiple solutions an applications are connected to single sign on like Red Hat SSO.

You should turn this off again before continuing.

Congratulations you have completed this exercise. 

- We have understood Open Id Connect

- Comparision of SAML and OIDC

- Configuring Client scopes, mappers and Grants. 

Lets move on the next section and get into some more details.

