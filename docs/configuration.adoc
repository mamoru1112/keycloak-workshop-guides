[#server-setup]
RH-SSOのデプロイが完了したので、いくつかの基本的な設定をします。

このセクションでは、smtp設定と電子メールアドレスを追加します。その後、メール認証とユーザー登録でフローをテストします。

[#email-integration]
=== メール連携の設定

シングルサインオンでは、ユーザーがログインすることを想定しており、よくある初回ログイン時の認証メールが送信できるようになります。

まずは、テストに使うだけのメールサーバーをセットアップしましょう。MailCatcherは超シンプルなSMTPサーバーで、送られてきたメッセージをすべてキャッチしてWebインターフェースに表示します。
MailCatcherを実行することで、テスト用に設定したすべてのメールを取得することができます。
メールサーバーはポート「1025」でセットアップされ、受信と送信のためのHTMLインターフェースはポート「8080」で設定します。
開発環境の画面に移動して、次のコマンドを実行して、テスト用メールサーバーを作成します。
画面の右側にあるワークベンチアイコンをクリックします。

image::crw_right_workbench.png[Workbench]

<1> Login to OpenShiftをクリックします。

<2> New Terminalをクリックします。

New Terminalで開いたターミナルで、以下のコマンドを実行します。

[source,bash,role="copypaste"]
----
oc new-app quay.io/sshaaf/mailcatcher --name=mailcatcher

oc expose svc/mailcatcher --port 8080
----

コマンドの説明

<1> 最初のコマンドでメールキャッチャーサーバーをデプロイします

<2> 2つ目のコマンドは、受信したメールを見るためのhttpエンドポイントを設定するために、8080番ポートを公開します。

デプロイが完了すると、OpenShiftのコンソールで次のように表示されます。

image::OpenShift_mailcatcherinstalled.png[Mailcatcher]

RH-SSO側の管理画面で設定をします。
まず、管理者用メールアカウントを追加します。
SSO 管理コンソールにログインしていることを確認し、SSO 管理コンソールの右端にあるメニューをクリックします。

`Manage account`　をクリックすると、管理者ユーザープロファイルが表示されます。

image::sso_adminprofile.png[Admin profile]

Personal Info画面が開くので、メールアドレスとFirst nameとLast nameを入力します。
Email： admin@mysso.com
First name:  適当でOK
Last name: 適当でOK

完了したら、 `save` ボタンを押して、　`Back to Security Admin Console`　に戻るをクリックします。

次に、`realm settings` をクリックし、 `Email` タブをクリックします。
さきほど設定した内容を入力します。
Host: mailcatcher
Port: 1025
From: admin@mysso.com

image::sso_adminemailconfig.png[Realm Email config]

`save` をクリックします。

では、早速テストしてみましょう。
`Test Connection` を押すと、設定がうまくいったかどうかが報告されます。
成功した場合、「[KEYCLOAK] - SMTP test message」などの件名で、メールが届きます。

OpenShiftコンソールのmailcatcherの右上のアイコンをクリックすると、メールが確認できます。

image::mailcatcher_ui.png[Email config]

これでEメールの設定は完了です。

では、 `Login` タブに移動します。

image::sso_adminloginconfig.png[Realm Login settings]

以下を有効にします:

1. `User Registration` 新しいユーザーがSSOに登録可能にします。

2. `Verify Email` メールによるユーザーを確認を有効化します。

`Save` をクリックします。

それでは、この設定をテストしていきます。
プライバシーモードで新しいブラウザセッションを開くか、別のブラウザを開いてください。
RH-SSOには、アカウント管理画面があり、そこからアカウントを登録します。

アカウント管理画面: https://sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}/auth/realms/demojs/account

<1> アカウント管理画面の右上の `Sing-in` をクリックすると、 ログイン画面が表示されます。

<2> `register` をクリックし、適当にユーザ情報を入力してください。

<3> 新しく作成されたユーザーを確認するためにメールが送信されるので、mailcatcherに送信されます。

ユーザ登録が完了すると、以下の画面が表示されます:

image::sso_adminemailverify.png[Realm Login settings]

mailcatcherにアクセスすると、新しい電子メールが届いているはずです。
メールに記載されているリンクをクリックし、新しいユーザーを確認します。これで、新しいユーザで管理コンソールにログインできるはずです。（確認メールのリンクをコピーして、ユーザ登録したブラウザ側で開いてください）

さて、これで RH-SSO サーバとそのレルムの基本的な設定ができました。
次の章では、最初のアプリケーションをデプロイします。そして、RH-SSO を使用するように設定します。
