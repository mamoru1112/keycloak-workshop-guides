[#server-setup]
RH-SSOのデプロイが完了したので、いくつかの基本的な設定をします。

このセクションでは、smtp設定と電子メールアドレスを追加します。その後、メール認証とユーザー登録でフローをテストします。

[#email-integration]
=== メール連携の設定

シングルサインオンでは、ユーザーがログインすることを想定しており、よくある初回ログイン時の認証メールが送信できるようになります。

まずは、テストに使うだけのメールサーバーをセットアップしましょう。MailCatcherは超シンプルなSMTPサーバーで、送られてきたメッセージをすべてキャッチしてWebインターフェースに表示します。
MailCatcherを実行することで、テスト用に設定したすべてのメールを取得することができます。
メールサーバーはポート「1025」でセットアップされ、受信と送信のためのHTMLインターフェースはポート「8080」で設定します。
開発環境の画面に移動して、次のコマンドを実行して、テスト用メールサーバーを作成します。
画面の右側にあるワークベンチアイコンをクリックします。

image::crw_right_workbench.png[Workbench]

<1> Login to OpenShiftをクリックします。

<2> New Terminalをクリックします。

New Terminalで開いたターミナルで、以下のコマンドを実行します。

[source,bash,role="copypaste"]
----
oc new-app quay.io/sshaaf/mailcatcher --name=mailcatcher

oc expose svc/mailcatcher --port 8080
----

コマンドの説明

<1> 最初のコマンドでメールキャッチャーサーバーをデプロイします

<2> 2つ目のコマンドは、受信したメールを見るためのhttpエンドポイントを設定するために、8080番ポートを公開します。

デプロイが完了すると、OpenShiftのコンソールで次のように表示されます。

image::OpenShift_mailcatcherinstalled.png[Mailcatcher]

RH-SSO側の管理画面で設定をします。
まず、管理者用メールアカウントを追加します。
SSO 管理コンソールにログインしていることを確認し、SSO 管理コンソールの右端にあるメニューをクリックします。

`Manage account`　をクリックすると、管理者ユーザープロファイルが表示されます。

image::sso_adminprofile.png[Admin profile]

Personal Info画面が開くので、メールアドレスとFirst nameとLast nameを入力します。
Email： admin@mysso.com
First name:  適当でOK
Last name: 適当でOK

完了したら、 `save` ボタンを押して、　`Back to Security Admin Console`　に戻るをクリックします。

次に、`realm settings` をクリックし、 `Email` タブをクリックします。
さきほど設定した内容を入力します。
Host: mailcatcher
Port: 1025
From: admin@mysso.com

image::sso_adminemailconfig.png[Realm Email config]

<1> Ensure that you have filled in the `From Display Name`, its not mandatory, but for this workshop if users are sharing emails, it will help alot.

Once done making changes `save`. 

Now lets make a quick test. `Test Connection`, once pressed will report back if your configuration was successful. If it is, an email should arrive in your inbox, with a subject e.g. 
'[KEYCLOAK] - SMTP test message'

Goto the mailcatcher service and you should see something similar.

image::mailcatcher_ui.png[Email config]


Perfect, now we have the email configuration. 

Lets move on to the `Login` tab.

image::sso_adminloginconfig.png[Realm Login settings]

Enable the following:

1. `User Registration` , User registration allows new users to register to the SSO

2. `Verify Email` , and this will ensure that we can verify the user by thier email.

Press `Save`

Now lets test our basic config. 
Open a new browser session in privacy mode, or open another browser. 
  
  * Ensure that you are not logged into the SSO admin panel in the newly opened browser sessions. 

Link to the console: https://sso-{{ USER_ID }}-keycloak.{{ ROUTE_SUBDOMAIN }}/auth/realms/demojs/account

<1> It should show a login screen, with a link under the buttons to register. 

<2> Hit the register button and register a new user. 

<3> Ensure that you fill in the an email address, since an email will be sent to verify the newly created user. ensure that this email address is not the same as used previously in this excercise. The email will land in our mailcatcher web-ui. 

Once you have registered you should see the following message:

image::sso_adminemailverify.png[Realm Login settings]

Head over to your email and you should have recieved a new email. Click on the link in the email to verify this new user. Now you should be able to login to the admin console with your new user. 

Great, so now we have some basic config for our RH-SSO server and its realm. Lets head off to the next section where we will deploy our first application. And subsequently configure it to use RH-SSO.
